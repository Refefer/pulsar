<html>
<head>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/highcharts.js"></script>
<script type="text/javascript" src="/static/js/pulsar_api.js"></script>
<script type="text/javascript" src="/static/js/pulsar.utils.js"></script>
<style>
html,body {
    margin: 0;
    padding: 0;
}
#graph {
    overflow:hidden;
}
</style>
<script type="text/javascript">
$(function() {
    // Get the data from the url
    var hashdata = PulsarUtils.data_from_hash();
    
    $('#graph').css({
        height: hashdata.height || window.innerHeight
    });
    

    Highcharts.setOptions({
        global: {
            useUTC: false
        }
    });

    var chart = new Highcharts.Chart({
        chart: {
            renderTo: 'graph',
            type: 'line',
            marginRight: 10,
        },
        title: {
            text: hashdata.title || 'Current Traffic'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
        },
        yAxis: {
            title: {
                text: hashdata.yaxis || 'Current Visitors'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            formatter: function() {
                    return '<b>'+ this.series.name +'</b><br/>'+
                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) +'<br/>'+
                    Highcharts.numberFormat(this.y, 2);
            }
        },
        legend: {
            enabled: true
        },
        exporting: {
            enabled: false
        },
        series: []
    });
    
    function add_series(name) {
        chart.addSeries({
            name: name,
            data: (function() {
                var time = new Date().getTime();
                var data = [];
                for(var i = 0; i < 100; i++) {
                    data.push({x: (time - (i * 5000)), y: 0});
                }
                return data.reverse();
            })()
        });
        return chart.series[chart.series.length-1];
    }

    var all_series = {};
    PulsarAPI.watch_key(hashdata.host, hashdata.key, function(data) {
        var time = new Date().getTime();
        console.log(JSON.stringify(data));
        var seen_series = {};
        for(var i = 0; i < data.length; i++) {
            var name = ""+data[i][0];
            var counter = data[i][1];
            var series = all_series[name];
            if(series === undefined) {
                series = all_series[name] = add_series(name);
            }
            series.addPoint([time, counter], true, true);
            seen_series[name] = 1;
        }

        // All the others got big 0-fers
        for(name in all_series) {
            if(seen_series[name] === undefined) {
                // Check if it's all zero and remove it is
                var series = all_series[name];
                var all_zero = true;
                for(var i = 0; i < series.data.length; i++) {
                    if(series.data[i].y > 0) {
                        series.addPoint([time, 0], true, true);        
                        all_zero = false;
                        break;
                    }
                }
                if(all_zero) {
                    series.remove();
                }
                
            }
        }

    });
    
});
</script>
</head>
<body>
<div id="graph"></div>
</body>
</html>
