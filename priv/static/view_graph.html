<html>
<head>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/highcharts.js"></script>
<script type="text/javascript" src="/static/js/pulsar_api.js"></script>
<script type="text/javascript" src="/static/js/pulsar.utils.js"></script>
<style>
html,body {
    margin: 0;
    padding: 0;
}
#graph {
    overflow:hidden;
}
</style>
<script type="text/javascript">
$(function() {
    // Get the data from the url
    var hashdata = PulsarUtils.data_from_hash();
    
    $('#graph').css({
        height: hashdata.height || window.innerHeight
    });
    
    Highcharts.setOptions({
        global: {
            useUTC: false
        }
    });

    var chart = new Highcharts.Chart({
        chart: {
            renderTo: 'graph',
            type: 'spline',
            marginRight: 10,
        },
        plotOptions: {
            series: {
                marker: {
                    enabled: false
                }
            }
        },
        title: {
            text: hashdata.title || 'Current Traffic'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
        },
        yAxis: {
            title: {
                text: hashdata.yaxis || 'Current Visitors'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            formatter: function() {
                    return '<b>'+ this.series.name +'</b><br/>'+
                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) +'<br/>'+
                    Highcharts.numberFormat(this.y, 2);
            }
        },
        legend: {
            enabled: true
        },
        exporting: {
            enabled: false
        },
        series: []
    });
    
    function add_series(time, name, init_value) {
        chart.addSeries({
            name: name,
            data: (function() {
                var data = [];
                for(var i = 0; i < (hashdata.points||100); i++) {
                    data.push({x: (time - (i * 5000)), y: init_value});
                }
                return data.reverse();
            })()
        }, false);
        return chart.series[chart.series.length-1];
    }

    var all_series = {};
    var count = 0;
    var filter_data = (function() {
        var filter = (function(filtered) {
            if(filtered === undefined) return filtered;
            if(typeof filtered === "string") return {filtered:1};
            var f = {};
            for(var i = 0; i < filtered.length; i++) {
                f[filtered[i]] = 1;
            }
            return f;
        })(hashdata.filter);

        // Filter function
        return function(data) {
            // Filter out those only names we care about
            if(filter !== undefined) {
                var new_data = [];
                for(var i = 0; i < data.length; i++) {
                    if(filter[data[i][0]]) {
                        new_data.push(data[i]);
                    }
                }
                data = new_data;
            }
            return data;
        }
    })();
    
    function normalize_data(data) {
        if(!hashdata.normalize) return data;

        data = data.slice();

        // Count up everything
        var total = 0;
        for(var i = 0; i < data.length; i++) {
            total += data[i][1];
        }

        // Normalize 
        for(var i = 0; i < data.length; i++) {
            data[i][1] = Math.round(100 * (data[i][1]/total));
        }

        return data;
    }

    // The magic, simple, Pulsar Api
    PulsarAPI.watch_key(hashdata.host, hashdata.key, function(data) {
        // Keep time consistent for all series.
        var time = new Date().getTime();

        // We want to sort series by name so when they are added, they look
        // more readable in the key.
        data = data.sort(function(a, b) {
            if(a[0] < b[0]) {
                return -1;
            } else if(a[0] > b[0]) {
                return 1
            }
            return 0;
        });

        data = filter_data(data);

        data = normalize_data(data);
        
        var seen_series = {};
        for(var i = 0; i < data.length; i++) {
            var name = ""+data[i][0];
            var counter = data[i][1];
            var series = all_series[name];
            if(series === undefined ) {
                series = all_series[name] = add_series(time, name, counter);
            } else {
                series.addPoint([time, counter], false, true);
            }
            seen_series[name] = 1;
        }


        // All the others got big 0-fers
        for(name in all_series) {
            if(seen_series[name] === undefined) {
                // Check if it's all zero and remove it is.  Poor man's
                // Garbage Collection
                var series = all_series[name];
                var all_zero = true;
                for(var i = 0; i < series.data.length; i++) {
                    if(series.data[i].y > 0) {
                        all_zero = false;
                        break;
                    }
                }
                if(all_zero) {
                    series.remove(false);
                    delete all_series[name];
                } else {
                    series.addPoint([time, 0], false, true);        
                }
                
            }
        }

        // Redraw
        chart.redraw();
    });
    
});
</script>
</head>
<body>
<div id="graph"></div>
</body>
</html>
